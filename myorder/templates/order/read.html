{% extends 'common/base.html' %}
{% block title %}[글쓰기]{% endblock title %}
{% block body %}
  <script>
    function showUpdateForm(rid, id) {
      location.href = id + '/update_reply?rid=' + rid;
    }
    $(document).ready(function () {
      loadReplyList();
    })

    function loadReplyList() {
      let bNum = '{{o.id}}';
      console.log(bNum);
      $.ajax({
        url: '{{' load_reply '}}',
        type: 'post',
        headers: {
          'X-CSRFTOKEN': '{{ csrf_token }}'
        },
        data: {
          'id': bNum
        },
        success: function (data) {
          let reply_list = JSON.parse(data['data'])
          console.log(reply_list);

          //바로바로 화면에 붙이려면 append
          $.each(reply_list, function (i, item) {
            //let reply_content = item.fields.reply_content;
            //$("#replyList").append(reply_content)
            let pk = item.pk;
            let user = item.fields.user;
            let reply_content = item.fields.reply_content;
            let input_date = item.fields.input_date;
          })

          // HTML을 만들어서 한번에 넣으려면 html

        }
      })
    }
  </script>
  <section class="flex flex-col gap-2">
    <p>글번호:
      {{o.id}}</p>
    <a class="cursor-pointer hover:bg-gray-400">
      <span>전체상품:</span>
      {% for o in oList%}
        <p>{{o}}</p>
      {% endfor %}
    </a>
    <p>가격:
      {{o.price}}</p>
    <p>글쓴이:
      {{o.address}}</p>
    <p>주문일시:
      {{o.order_date}}</p>
  </section>
  <div class="flex flex-row gap-4 justify-center">
    <!--auther.username 는 user하고 비교한다-->
    {% if o.author.username == user.username %}
      <a href="{%url 'order:update' o.id %}">수정</a>
      <a href="{%url 'order:delete' o.id %}">삭제</a>
    {% endif %}
    <a href="{% url 'order:index' %}" class="bg-black text-white p-4 rounded-md">목록으로</a>
  </div>
  <div id="replyArea">
    {# 댓글 목록 표시할 곳#}
    {# 댓글 입력폼#}
    <div class="w-full h-28 text-lg">
      {% if not update %}
        <form action="{% url 'order:write_reply' o.id %}" method="post" class="w-full flex items-center justify-between p-4 gap-4">
          {% csrf_token %}
          <textarea name="reply_content" placeholder="댓글 내용을 입력해주세요!" class="flex flex-1 border"></textarea>
          <input type="submit" value="댓글작성" class="bg-black text-white w-40 py-4 rounded-md">
        </form>
      {% else %}
        <!--context에 update가 없을떄-->
        <form action="{% url 'order:update_reply' o.id %}" method="post" class="w-full flex">
          {% csrf_token %}
          <input type="hidden" name="rid" value="{{r.id}}">
          <textarea name="reply_content" placeholder="댓글 내용을 입력해주세요!" class="flex flex-1 border">{{r.reply_content}}</textarea>
          <input type="submit" value="댓글수정" class="bg-black text-white w-40 py-4 rounded-md">
        </form>
      {% endif %}
    </div>
    <div class="flex flex-col gap-2 p-4">
      {# order 객체 뿐만 아니라 order와 FK로 엮인 객체는 o.모델이름_set으로 가져올수있다 #}
      {% if o.reply_set %}
        {% for r in o.reply_set.all %}
          <section class="flex flex-row gap-4 items-center justify-between border p-2 rounded-md hover:bg-gray-100">
            {#댓글 내용 작성자#}

            <div class="flex flex-col gap-6 p-2">
              <p class="flex gap-4">
                <span class="font-bold">작성자:{{r.user}}</span>
                <span class="text-gray-400 text-xs">{{r.input_date}}</span>
              </p>
              <span>{{r}}</span>
            </div>
            {# 버튼 영역 #}
            <div class="flex flex-row gap-2 bg-gray-50">
              <a href="#" onclick="javascript:showUpdateForm('{{r.id}}', '{{o.id}}')" class="bg-blue-400 p-2 rounded-md text-white">수정</a>
              <a href="{% url 'order:delete_reply' id=o.id rid=r.id %}" class="bg-red-400 p-2 rounded-md text-white">삭제</a>
            </div>
          </section>
        {% endfor %}
      {% else %}
        <p>등록된 댓글이 없습니다.</p>
      {% endif %}
    </div>
  </div>
{% endblock body %}